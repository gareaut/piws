<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
  
    <title>Population Imaging Web Service &mdash; PIWS</title>
  <!-- htmltitle is before nature.css - we use this hack to load bootstrap first -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="_static/css/bootstrap.min.css" media="screen" />
  <link rel="stylesheet" href="_static/css/bootstrap-responsive.css"/>

    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PIWS" href="index.html" />
    <link rel="next" title="Documentation of the ‘PIWS’ cube" href="documentation.html" />
    <link rel="prev" title="Population Imaging Web Service: PIWS" href="index.html" />
  
   
       <script type="text/javascript" src="_static/sidebar.js"></script>
   
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="_static/js/bootstrap.min.js" type="text/javascript"></script>
  <!-- <link rel="canonical" href="https://bioproj.extra.cea.fr/redmine/projects/nsap/installation.html" /> -->

  <script type="text/javascript">
    $("div.buttonNext, div.buttonPrevious").hover(
       function () {
           $(this).css('background-color', '#FF9C34');
       },
       function () {
           $(this).css('background-color', '#A7D6E2');
       }
    );
    var bodywrapper = $('.bodywrapper');
    var sidebarbutton = $('#sidebarbutton');
    sidebarbutton.css({'height': '900px'});
  </script>

  </head>
  <body role="document">

<div class="header-wrapper">
  <div class="header">
    <p class="logo">
      <a href="index.html">
        <img src="_static/nsap.png" alt="Logo"/>
      </a>
    </p><div class="navbar">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="#">Installation</a></li>
        <li class="btn-li">
          <div class="btn-group">
		    <a href="documentation.html">Documentation</a>
		    <a class="btn dropdown-toggle" data-toggle="dropdown">
		      <span class="caret"></span>
		    </a>
		    <ul class="dropdown-menu">
	          <li class="link-title">PIWS</li>
			  <li class="divider"></li>
			  <li><a href="rights.html">Rights management</a></li>
			  <li><a href="views.html">Views</a></li>
			  <li><a href="features.html">Features documentation</a></li>
			  <li class="divider"></li>
			  <li><a href="scripts.html">Importation procedures</a></li>
			  <li><a href="parsers.html">Standard parsers</a></li>
			  <li class="divider"></li>
			  <li><a href="download.html">Download</a></li>
			  <li><a href="upload.html">Upload</a></li>
		    </ul>
		  </div>
        </li>
        <li><a href="http://neurospin-wiki.org/">NeuroSpin Wiki</a></li>
      </ul>
    </div> <!-- end navbar --></div>
</div>


<div class="content-wrapper">
    <div class="sphinxsidebar">
      <div class="sphinxsidebarwrapper">

        <!-- info setup -->
        <p class="citing">
          If you use the software, please do not hesitate to 
          <a href="https://github.com/neurospin/piws">report a bug</a>.
        </p>

      <!-- toc tree -->
      <ul>
<li><a class="reference internal" href="#">Installing <cite>PIWS</cite></a><ul>
<li><a class="reference internal" href="#installing-a-dss-from-scratch">Installing a DSS from scratch</a><ul>
<li><a class="reference internal" href="#setup-environment">Setup environment</a></li>
<li><a class="reference internal" href="#instance-creation-and-configuration">Instance creation and configuration</a></li>
<li><a class="reference internal" href="#generating-and-importing-a-toy-dataset">Generating and importing a toy dataset</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-a-virtual-machine">Running a virtual machine</a></li>
</ul>
</li>
</ul>


      </div>
    </div>
  

  <div class="content">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="installing-piws">
<span id="install-guid"></span><h1>Installing <cite>PIWS</cite><a class="headerlink" href="#installing-piws" title="Permalink to this headline">¶</a></h1>
<p>This tutorial walk you through the process of installing a data sharing
service (DSS) based on the the Population Imaging Web Service (PIWS) cube.
Two strategies are proposed: create a demonstrator DSS by
<a class="reference internal" href="#install-scratch"><span>installing the CW environement from scratch</span></a> or by
<a class="reference internal" href="#install-vm"><span>running a virtual machine</span></a>. For testing, we recommand the
second option.</p>
<div class="section" id="installing-a-dss-from-scratch">
<span id="install-scratch"></span><h2>Installing a DSS from scratch<a class="headerlink" href="#installing-a-dss-from-scratch" title="Permalink to this headline">¶</a></h2>
<p>The CW environment needs to be installed in order to setup the demonstrator.
This tutorial was tested with CW 3.20.9. Please visit the
<a class="reference external" href="https://docs.cubicweb.org">CW website</a> for a
detailed procedure on how to install CW.
In addition &#8216;postgresql&#8217; and &#8216;postgresql-plpython&#8217; must be installed. Notice
that a PostgreSQL account is required:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">whoami</span>
<span class="go">me</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sudo</span> <span class="o">-</span><span class="n">u</span> <span class="n">postgres</span> <span class="n">createuser</span> <span class="o">-</span><span class="n">P</span> <span class="o">-</span><span class="n">s</span> <span class="n">me</span>
</pre></div>
</div>
<p>Then configure CW by changing the resource mode and augmenting the default
search path for cubes:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&gt;&gt;&gt; mkdir -p $HOME/cw/cubes
&gt;&gt;&gt; mkdir -p $HOME/cw/repositories
&gt;&gt;&gt; export CW_MODE=user
&gt;&gt;&gt; export CW_CUBES_PATH=$HOME/cw/cubes
&gt;&gt;&gt; export PYTHONPATH=$PYTHONPATH:$HOME/cw
</pre></div>
</div>
<div class="section" id="setup-environment">
<h3>Setup environment<a class="headerlink" href="#setup-environment" title="Permalink to this headline">¶</a></h3>
<p>A CW instance is made of several base cubes. A helper package is proposed to
import the required PIWS cube dependencies. First install the helper package:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="n">piws_setup</span>
</pre></div>
</div>
<p>Since the helper package has been installed using the user scheme in the
previous section, you may have to update the path to executable files:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&gt;&gt;&gt; export PATH=$PATH:$HOME/.local/bin
</pre></div>
</div>
<p>If you have root privileges on the machine, you may use a standard
installation (without the &#8211;user option) to avoid the previous step.
Then execute the setup script:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&gt;&gt;&gt; piws_setup -d $HOME/cw/repositories
</pre></div>
</div>
<p>Select the appropriate configuration depending on the installed version of CW.
This information can be accessed by typing:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cubicweb</span><span class="o">-</span><span class="n">ctl</span> <span class="nb">list</span>
</pre></div>
</div>
</div>
<div class="section" id="instance-creation-and-configuration">
<h3>Instance creation and configuration<a class="headerlink" href="#instance-creation-and-configuration" title="Permalink to this headline">¶</a></h3>
<p>Create a PIWS instance named &#8216;toy_instance&#8217;:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cubicweb</span><span class="o">-</span><span class="n">ctl</span> <span class="n">create</span> <span class="n">piws</span> <span class="n">toy_instance</span>
</pre></div>
</div>
<p>To be compliant with following documentation, we recommend to authorize
anonymous access to the database.
Four specific items must be configured when a DSS is created: the WEB, PIWS,
RQL_UPLOAD and RQL_DOWNLOAD features.
They can be configured during the instance creation or by editing the instance
associated &#8216;all-in-one.conf&#8217; configuration file (see its location below).
The different basic configurations are reviewed in the following paragraphs:</p>
<ul>
<li><p class="first"><strong>Web configuration:</strong> In order to access the CW instance through a web
browser, a port has to be defined. It is also possible to control the
maximum length of an HTTP/HTTPS request. This latter option will be critical
when large files are uploaded with the proposed system. To set up the previous
options, modify the configuration file
&#8216;$HOME/etc/cubicweb.d/toy_instance/all-in-one.conf&#8217; as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[WEB]

# http server port number (default to 8080)
port=8080

# maximum length of HTTP request. Default to 100 MB.
max-post-length=200MB
</pre></div>
</div>
</li>
<li><p class="first"><strong>PIWS configuration:</strong> In the instance configuration file located here
&#8216;$HOME/etc/cubicweb.d/toy_instance/all-in-one.conf&#8217;, set the following options
to activate the login/logout:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">PIWS</span><span class="p">]</span>

<span class="c1"># Show or not the user status link on the website.</span>
<span class="n">show_user_status</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>Upload configuration:</strong> In the instance configuration file located here
&#8216;$HOME/etc/cubicweb.d/toy_instance/all-in-one.conf&#8217;, set the following options
to activate the upload functionality:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[RQL_UPLOAD]

# base directory in which files are uploaded.
upload_directory=/tmp/upload

# JSON file describing the different upload entities.
upload_structure_json=/home/me/cw/repositories/rql_upload/demo/demo.json

[PIWS]

# If true enable the upload, ie relax security on user and group entities.
enable-upload=yes

# A list of groups that will be able to upload data.
authorized-upload-groups=uploaders
</pre></div>
</div>
</li>
<li><p class="first"><strong>Twisted server (recommended):</strong> In the instance configuration file located at
&#8216;$HOME/etc/cubicweb.d/toy_instance/all-in-one.conf&#8217;, set the following options
to activate the Twisted sFTP server that will expose the content of each CW
search:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[RQL_DOWNLOAD]

# specifies expiration delay of CWSearch (in days)
default_expiration_delay=1

# base directory in which files are stored (this option is given to the ftp
# server and fuse processes)
basedir=/tmp

# if true cubicweb will start automatically sftp server (you need to set
# properly the configuration file: see the documentation)
start_sftp_server=yes
</pre></div>
</div>
<p>A configuration file defining where the Twisted server is listening and which
CW instance(s) is(are) concerned must be set at location
&#8216;$HOME/.config/rsetftp&#8217;:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[rsetftp]

cubicweb-instance=toy_instance
port=9191
private-key=/home/me/.ssh/id_rsa
public-key=/home/me/.ssh/id_rsa.pub
unix-username=me
</pre></div>
</div>
<p>The authentication key can be generated with the &#8216;ssh-keygen&#8217; command.</p>
</li>
<li><p class="first"><strong>Fuse virtual folders:</strong> In the instance configuration file located here
&#8216;$HOME/etc/cubicweb.d/toy_instance/all-in-one.conf&#8217;, set the following options
to activate the Fuse virtual folders creation from CW searches:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>[RQL_DOWNLOAD]

# specifies expiration delay of CWSearch (in days)
default_expiration_delay=1

# base directory in which files are stored (this option is given to the ftp
# server and fuse processes)
basedir=/tmp

# base directory in which fuse will mount the user virtual directories
mountdir=/home/me/tmp/fuse

# if true cubicweb will start automatically a fuse mount per user when the user
# has some CWSearch entities.
start_user_fuse=yes
</pre></div>
</div>
<p>In the &#8216;mountdir&#8217;, a specific hierarchy for each CW user (here &#8216;me&#8217;) has to be
defined:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>- - me
    |
     - - toy_instance
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="generating-and-importing-a-toy-dataset">
<h3>Generating and importing a toy dataset<a class="headerlink" href="#generating-and-importing-a-toy-dataset" title="Permalink to this headline">¶</a></h3>
<p>A script is proposed in the PIWS cube to create a toy dataset (use the proposed
default values):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&gt;&gt;&gt; python $HOME/cw/repositories/piws/piws/demo/generate_toy_dataset.py
Enter a valid folder [default: /tmp]:
Enter the number of subject for the demo [10, 50]: 10
</pre></div>
</div>
<p>The demonstration dataset has been generated in the &#8216;/tmp/demo&#8217; folder. This
latter can be imported in the previously created &#8216;toy_instance&#8217; instance using
PIWS uniformed insertion procedure:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&gt;&gt;&gt; python $HOME/cw/repositories/piws/piws/demo/import_toy_dataset.py
Enter the instance name [default: toy_instance]:
Enter where are the demo data [default: /tmp/demo]:
Enter the &#39;toy_instance&#39; login [default: anon]:
Enter the &#39;toy_instance&#39; password [default: anon]:
</pre></div>
</div>
<p>The CW instance can be started and access via a web browser at the configured
port (here the default 8080 port):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cubicweb</span><span class="o">-</span><span class="n">ctl</span> <span class="n">start</span> <span class="n">toy_instance</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">firefox</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="running-a-virtual-machine">
<span id="install-vm"></span><h2>Running a virtual machine<a class="headerlink" href="#running-a-virtual-machine" title="Permalink to this headline">¶</a></h2>
<p>We propose an Oracle VirtualBox VDI image <a class="reference external" href="ftp://ftp.cea.fr/pub/unati/nsap/virtualbox/PIWS-DEMO.vdi">here</a> with a PIWS DSS installed on
an Ubuntu 16.04LTS operating system.
This DSS highlights the collect and publication functionalities of the proposed
framework.
When the VM is started, a service start automatically the DSS.
Launch Firefox using the left launch bar to access the DSS login prompt.
Three users have been registered in the system with different access rights:</p>
<ul>
<li><dl class="first docutils">
<dt>login: user1 - password: user1:</dt>
<dd><p class="first last">have an access to the timepoint V0 data and can upload some data to the
system.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>login: user2 - password: user2:</dt>
<dd><p class="first last">have an access to the timepoint V1 data.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>login: user3 - password: user3</dt>
<dd><p class="first last">have an access to all the data.</p>
</dd>
</dl>
</li>
</ul>
<p>The saved searches can be downloaded using FileZilla.
Launch FileZilla using the left launch bar.
On the FileZilla main frame, select the top left toolbar icon: &#8216;Open the Site
Manager&#8217;.
Three sites have been registered to access the searches of each user.</p>
</div>
</div>


          </div>
        </div>
      </div>
    <div class="clearer">
    </div>
  </div>
  
</div>

<div class="footer">
    &copy; 2015, NSAp developers &lt;antoine.grigis@cea.fr&gt;.
</div>
  </body>
</html>